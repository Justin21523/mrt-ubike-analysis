services:
  api:
    build: .
    container_name: metrobikeatlas-api
    init: true
    ports:
      - "127.0.0.1:8000:8000"
    env_file:
      - .env
    environment:
      - METROBIKEATLAS_DEMO_MODE=false
      - METROBIKEATLAS_HOST=0.0.0.0
      - METROBIKEATLAS_PROXY_HEADERS=true
      - METROBIKEATLAS_FORWARDED_ALLOW_IPS=*
      - METROBIKEATLAS_STORAGE=sqlite
      - METROBIKEATLAS_LAZY_BIKE_TS=true
      # Docker port mapping shows client IP as a private bridge IP; allow admin endpoints for local ops.
      - METROBIKEATLAS_ALLOW_PRIVATE_ADMIN=true
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    restart: unless-stopped
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8000/status"]
      interval: 15s
      timeout: 3s
      retries: 10

  collector:
    build: .
    container_name: metrobikeatlas-collector
    init: true
    env_file:
      - .env
    environment:
      - METROBIKEATLAS_DEMO_MODE=false
      - METROBIKEATLAS_STORAGE=sqlite
      # Conservative defaults for long-running local ops:
      - TDX_MIN_REQUEST_INTERVAL_S=0.6
      - TDX_REQUEST_JITTER_S=0.2
      - TDX_SKIP_METRO_STATIONS=true
      - BUILD_SILVER_WRITE_SQLITE=true
      # Keep a short rolling window of raw Bronze JSON (older data is archived by `scheduler`).
      - BRONZE_RETAIN_AVAIL_FILES_PER_CITY=${BRONZE_RETAIN_AVAIL_FILES_PER_CITY:-500}
      - BRONZE_RETAIN_AVAIL_DAYS=${BRONZE_RETAIN_AVAIL_DAYS:-3}
      - BRONZE_RETAIN_STATIONS_FILES_PER_CITY=${BRONZE_RETAIN_STATIONS_FILES_PER_CITY:-30}
      - BRONZE_CLEANUP_INTERVAL_SECONDS=${BRONZE_CLEANUP_INTERVAL_SECONDS:-600}
      # Disk safety (tune based on your machine). When disk is low, collector enters cleanup-only mode.
      - MIN_FREE_DISK_BYTES=${MIN_FREE_DISK_BYTES:-2147483648}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    command:
      [
        "python",
        "scripts/collect_tdx_continuous.py",
        "--availability-interval-seconds",
        "600",
        "--stations-refresh-interval-hours",
        "24",
        "--jitter-seconds",
        "5",
        "--build-silver-interval-seconds",
        "1800",
      ]
    restart: unless-stopped
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "scripts/collector_status.py", "--repo-root", "/app"]
      interval: 30s
      timeout: 5s
      retries: 10

  scheduler:
    build: .
    container_name: metrobikeatlas-scheduler
    init: true
    env_file:
      - .env
    environment:
      - METROBIKEATLAS_DEMO_MODE=false
      - METROBIKEATLAS_STORAGE=sqlite
      # Scheduler intervals (seconds)
      - SCHEDULER_TICK_SECONDS=30
      - SCHEDULER_DQ_INTERVAL_SECONDS=1800
      - SCHEDULER_GOLD_INTERVAL_SECONDS=1800
      - SCHEDULER_ARCHIVE_INTERVAL_SECONDS=86400
      # Archive Bronze daily: keep long history in tar.gz; delete old JSON after archiving.
      - ARCHIVE_BRONZE_OLDER_THAN_DAYS=${ARCHIVE_BRONZE_OLDER_THAN_DAYS:-3}
      - ARCHIVE_DELETE_AFTER=${ARCHIVE_DELETE_AFTER:-true}
      - ARCHIVE_MIN_FREE_DISK_BYTES=${ARCHIVE_MIN_FREE_DISK_BYTES:-2147483648}
      - ARCHIVE_MAX_BYTES=${ARCHIVE_MAX_BYTES:-0}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    command: ["python", "scripts/scheduler_loop.py", "--repo-root", "/app"]
    restart: unless-stopped
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "scripts/scheduler_status.py", "--repo-root", "/app"]
      interval: 30s
      timeout: 5s
      retries: 10

  weather:
    build: .
    container_name: metrobikeatlas-weather
    init: true
    env_file:
      - .env
    environment:
      - METROBIKEATLAS_DEMO_MODE=false
      # Open-Meteo (no API key) -> writes `data/external/weather_hourly.csv`
      - WEATHER_CITY=${WEATHER_CITY:-Taipei}
      - WEATHER_LAT=${WEATHER_LAT:-25.0330}
      - WEATHER_LON=${WEATHER_LON:-121.5654}
      - WEATHER_INTERVAL_SECONDS=${WEATHER_INTERVAL_SECONDS:-1800}
      - WEATHER_PAST_DAYS=${WEATHER_PAST_DAYS:-7}
      - WEATHER_RETAIN_DAYS=${WEATHER_RETAIN_DAYS:-365}
      - WEATHER_MIN_REQUEST_INTERVAL_S=${WEATHER_MIN_REQUEST_INTERVAL_S:-1.0}
      - WEATHER_REQUEST_JITTER_S=${WEATHER_REQUEST_JITTER_S:-0.5}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    command: ["python", "scripts/collect_weather_open_meteo.py"]
    restart: unless-stopped
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "python", "scripts/weather_status.py", "--repo-root", "/app"]
      interval: 60s
      timeout: 5s
      retries: 10
